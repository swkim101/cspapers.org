Watermarking has become an important technique for providing copyright protection for images, audio, VLSI designs, and many other types of data. Hidden information is embedded in data which allows the owner of the data to trace pirated copies, identifying a guilty party. We consider here the problem of watermarking maps. Our work is motivated by the following setting: MapQuest generates a database of map information (represented as a graph) and sells differently modified copies to several web sites like Yahoo!. These web sites respond to end-user queries which ask how far apart two locations are, or how to drive from one to the other. When MapQuest encounters a web site answering such queries, it would like to ascertain if the site is using a copy of its database, and if so which copy, all based only on how the site responds to its queries. This setting introduces two new and interesting problems for watermarking. First, because of the structure of shortest paths in a graph, modifications are not independent, and even small modifications can accumulate to a large overall distortion. Second, access to the data being tested is indirect, with access only provided via queries. We study this problem in various abstract settings that highfight the unique aspects of watermarking maps as well as give insights into the underlying combinatorial structure. Building on the in.sights from simple models, we design and analyze a watermarking scheme in a general setting which corresponds naturally to the example above. In the context of this more realistic model, we show that. a map owner can distribute a large number of copies introducing only a negligible distortion, and further that sites using pirated data axe likely to be detected even if they attempt to conceal their identity. 1 I n t r o d u c t i o n With the widespread availability of digital information, the problem of protecting that information from illicit copying has gained new prominence. A widely used method for addressing this problem is watermarking (also called fingerprinting [11]), where one embeds hidden information into the da ta which encodes ownership and copyright information. Data suspected of being pirated can then be tested for this hidden information, determining if the data is copyrighted. Furthermore, by " r IY~ar tmen t of Computer and Information Science, University of Pennsylvania, Philadelphia, PA 19104. This work was done when the author was at Bell Laboratories, Murray Hill, NJ. Emall : sanjeev~cis.upenn.edu. tDepar tment of Fundamental Mathematics Research, Bell Labs, 700 Mountain Avenue, Murray Hill, NJ 07974. E-mail: francis@research.bell-labs.com. URL: http ://cm. bell-labs, com/cm/ms/~ho/francis. embedding unique hidden information into each copy, pirated da ta can be traced back to its original purchaser. This approach has been applied to a wide range of media: images [3, 4], audio [1], video, etc. More recently, intellectual-property protection problems related to VLSI design, such as placement and routing [5] and implementat ions of finite state machines [7], have also been addressed in this fashion. In addition, there are cryptographic protocols which address related issues, such as how to distribute copies with guarantees of anonymity and reliable authentication [8, 9]. In this paper, we study the application of watermark ing techniques to protect map data. Consider the following situation. Through expensive surveys, a company, referred to as the owner of the map, compiles accurate map data, represented by a weighted graph where nodes represent locations, edges represent links between locations, and the weights represent the distance between adjacent locations. This da ta is then sold to other parties called providers who provide endusers access to it. This access is generally indirect: the provider allows the end-users to query pairs of nodes, and responds to each query with appropriate information related to the pair, such as the distance between the nodes, or a shortest route, or both. This situat ion already exists for maps of the US roadway system, with companies such as MapQuest acting as map owners, web sites like Yahoo! acting as providers, and endusers across the Internet. In addition, it is not hard to envision similar situations in which this could arise, such as providing routing information on a network. T h e M a p W a t e r m a r k i n g P r o b l e m : The goal of this paper is to present watermarking schemes (marking schemes) which allow the owner to distribute and identify many different copies of his original graph G, with associated edge lengths e(e), in order to protect this m a p data. Each t ime the owner sells a copy of the m a p to a provider, he distributes a copy with a unique set of modifications, refered to as a marked copy, which consists of the original graph G with new edge lengths t ' ( e ) . Gross modifications to the structure of the graph, such as introducing new nodes or edges, are not allowed, since the resulting marked copies are clearly incorrect. At the same time, changes in length which are small