As increasing amount of XML data is exchanged over the internet, copyright protection of this type of data is becoming an important requirement for many applications. In this paper, we introduce a rights protection scheme for XML data based on digital watermarking. One of the main challenges for watermarking XML data is that the data could be easily reorganized by an adversary in an attempt to destroy any embedded watermark. To overcome it, we propose a query-based watermarking scheme, which creates queries to identify available watermarking capacity, such that watermarks could be recovered from reorganized data through query rewriting. The identifier queries are tied closely to the usability of the data, and are highly resilient to reorganization and alteration attacks. In addition, our scheme considers data semantics to avoid vulnerabilities caused by redundancy, while taking advantage of the available watermark capacity. Based on this scheme, we have designed and implemented a watermarking solution for XML, and experimentally verified the effectiveness of the solution and its potential for real world applications.