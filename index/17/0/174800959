In recommender systems, usually the ratings of a user to most items are missing. A critical problem in recommendation learning is that, in reality, the missing ratings are often missing not at random (MNAR). MNAR ratings make it difÔ¨Åcult to accurately predict the ratings and unbiasedly estimate the performance of rating prediction. Recent approaches use imputed errors to recover the prediction errors for missing ratings, or weight observed ratings with the propensities of being observed. These approaches can still be severely biased in performance estimation or suffer from the variance of the propensities. We propose a principled approach to overcome these limitations. First, we propose an estimator that integrates the imputed errors and propensities in a doubly robust way to obtain unbiased performance estimation and alleviate the effect of the propensity variance. Based on this estimator, we propose joint learning of rating prediction and error imputation to achieve good performance guarantees. Extensive experiments show that our approach outperforms the state-of-the-art on four real-world datasets.