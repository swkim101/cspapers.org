As IoT applications gain widespread adoption, it becomes important to design and implement IoT protocols with security. Existing research in protocol security reveals that the majority of disclosed protocol vulnerabilities are caused by incorrectly implemented message parsing and network state machines. Instead of testing and Ô¨Åxing those bugs after development, which is extremely expensive, we would like to avert them upfront. For this purpose, we propose P RO F AC - TORY which formally and unambiguously models a protocol, checks model correctness, and generates a secure protocol implementation. We leverage P RO F ACTORY to generate a group of IoT protocols in the Bluetooth and Zigbee families and the evaluation demonstrates that 82 known vulnerabilities are averted. P RO F ACTORY will be publicly available [1].